---
title: "OPen Plant Pathology - Member directory"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    logo: opp-logo.png
    social: [ "twitter", "facebook" ]
    navbar:
      - { title: "<i class='fa fa-arrow-circle-left' aria-hidden='true'></i> Back to Open Plant Pathology", href: "http://openplantpathology.netlify.com", align: left }
      - { title: "<i class='fa fa-github' aria-hidden='true'></i> GitHub", href: "https://github.com/openplantpathology/OpenPlantPathology/tree/master/public/directory", align: left }
    
---

<link rel="stylesheet" href="fontawesome.min.css">


```{r include=FALSE}
Sys.setlocale("LC_ALL", "pt_BR.UTF-8")
```


```{r include=FALSE}


# read data from google sheets

library(gsheet)
members <-
  gsheet2tbl(
    "https://docs.google.com/spreadsheets/d/1VHGz8oWia5qvleUozznCIgd9bD85XoXm1NWmE6t8nzo/edit?usp=sharing"
  )

# prepare the dataset for table, plot and map

library(tidyverse)
members6 <- members %>%
  unite(geo,
        location,
        state,
        country,
        remove = F,
        sep = ", ") %>%
  replace_na(list(
    domain1 = "",
    domain2 = "",
    middle_name = ""
  )) %>%
  unite(domain, domain1, domain2, remove = T, sep = "  ") %>%
  unite(name, first_name, middle_name, last_name, sep = " ") %>%
  
  select(name, role, domain, institution, country, lon, lat)
```


Column {data-width=700px}
----------------------------------

### <i class="fa fa-table" aria-hidden="true"></i> Member information

```{r echo=FALSE}

# dynamic table using DT package

library(DT)
members66 <- members6 %>%
  select(name, role, domain, institution, country)
# we do not need to show lat and long here

datatable(
  members66,
  escape = FALSE,
  rownames = FALSE,
  colnames = c("Name", "Role", "Domain(s)", "Institution", "Country"),
  class = "cell-border stripe",
  options = list(
    order = list(list(0, "asc")),
    # order by first variable
    autoWidth = TRUE,
    columnDefs = list(list(width = "120px", targets = c(0))),
    scroller = TRUE,
    pageLength = 25,
    fontSize = 12,
    lengthMenu = c(25, 50, 100)
  )
) %>%
  formatStyle(c("name", "role", "domain", "institution", "country"),
              fontSize = "90%")
```



Column {}
----------------------------------

###  <i class="fa fa-map" aria-hidden="true"></i> Global map


```{r echo=FALSE}
library(leaflet)

pal <- colorFactor(c("#339933", "steelblue", "#e68a00"), domain = c("Editor", "Reviewer", "Member"))

getColor <- function(members6) {
  lapply(members6$role, function(role) {
    if (role == "Editor") {
      "green"
    } else if (role == "Member") {
      "blue"
    } else {
      "orange"
    }
  })
}
icons <- awesomeIcons(
  icon = "user-o",
  iconColor = "black",
  library = "fa",
  squareMarker = TRUE,
  markerColor = getColor(members6)
)
library(magrittr)
map <- leaflet(members6) %>%
  setView(lng = 0, lat = 5, zoom = 1) %>%
  addTiles(urlTemplate = "https://mts1.google.com/vt/lyrs=r&hl=en&src=app&x={x}&y={y}&z={z}&s=G", attribution = "Google") %>%
  addAwesomeMarkers(~lon, ~lat, icon = icons, label = ~as.character(name), clusterOptions = markerClusterOptions()) %>%
  addLegend("bottomleft", pal = pal, values = ~role, title = "Role", opacity = 1) %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Back to initial view",
    onClick = JS("function(btn, map){ map.setZoom(1); }")
  ))
map
```


### <i class="fa fa-bar-chart" aria-hidden="true"></i> Members by knowledge domain


```{r echo=FALSE}
library(plotly)

p <- members %>% # we use the original dataframe here
  select(domain1, domain2) %>%
  gather(domain) %>%
  select(value) %>%
  na.omit() %>%
  ggplot(aes(value, fill = value)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "right", axis.text.x = element_blank()) +
  labs(fill = "Domain", y = "Number of Members", x = "", title = "Members acting in up to two domains")
(gg <- ggplotly(p))
```


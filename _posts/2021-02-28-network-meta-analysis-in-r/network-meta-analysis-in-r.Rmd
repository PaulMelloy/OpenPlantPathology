---
title: "Network meta-analysis in R"
description: |
  Meta-analysis has gained popularity in Plant Pathology. Among the several methods, Network Meta-Analysis has been thoroughly presented to plant pathologists in a recent paper. In this post, I reproduce the analysis of the original paper which was conducted using SAS. Although the results are not identical, they are very similar. 
author:
  - name: Emerson Del Ponte
    url: https://twitter.com/edelponte
date: 02-28-2021
output:
  distill::distill_article:
    self_contained: false
draft: TRUE
bibliography: references.bib
category: 
  - R4PlantPath
preview: meta.png
---

### Why and who is this post for?

Meta-analysis has gained popularity in Plant Pathology. Among the several methods, Network Meta-Analysis (NMA) models, also known as Mixed Treatment Comparison (MTC), has been thoroughly presented to plant pathologists in a recent review paper in *Phytopathology* @madden2016.

A recent survey (Del Ponte, unpublished) showed more than 50 scientific articles published using plant disease-related data, mainly to test treatment effects related with fungicide efficacy. Although this is VERY little compared with other fields such as medicine and psychology fields, there is a trend towards increasing its use in our field, especially with some structures of the data for which a multiple treatment comparison is of interest (see links to papers at the end of this post). Hence, this post is for those who have interest in learning how to fit network models using open source tools, as alternative to SAS and other commercial software.

As a use case, I reproduce the analysis in the review paper wher the authors made available all the data (wheat yield response to fungicides) and the codes using SAS @madden2016, using one meta-analysis-specific packages in R, the [metafor](https://www.metafor-project.org/doku.php/help) package, which allowed me to fit the same model, the arm-based or uncondional, fitted in the original paper. I will reproduce some, not all, of the arm-based models presented in the original paper using a meta-analysis-specific package called `metafor`. I will explain the details on how to prepare the data, visualize the responses, fit the models and compare results with the original paper.

You should be able to reproduce the analysis below by copying and pasting into R. To facilitate instant access and reproducibility, I created an RStudio project in the cloud where anyone can run this code and get the same results. [Click here to get access to the R projet in the cloud](https://rstudio.cloud/project/2250558)

### Data preparation

The data were obtained from the supplemental [FileS1](https://apsjournals.apsnet.org/doi/suppl/10.1094/PHYTO-12-15-0342-RVW/suppl_file/PHYTO-12-15-0342-RVW.s1.sas), a SAS file that contains a documented code and the data. Here, the data were organized in an MS Excel file following the same original structure and content, excepting that missing data was represented by an empty cell. Let's load some packages for data importing and wrangling.

```{r message=FALSE, warning=FALSE}
library(tidyverse) # load several useful pkgs
library(readxl) # import data excel data

```

Now we are ready to import the data and convert both yield and variance to metric unit as performed in the paper. Note: we do not need to create the weight variable as in the SAS code because this is handled in the meta-analysis specific R packages.

```{r}
wheat <- read_excel("wheat.xlsx")
wheat <- wheat %>% 
  mutate(varyld = (1/wtyield)*(0.0628^2), 
         yield = yield * 0.0628) %>% 
  na.omit() # here we omit the rows with missing data
```

Let's replace the names of the levels of the treatment factor from number to acronym.

```{r}
wheat <- wheat %>%
  mutate(trt = replace(trt, trt == 10, "CTRL")) %>% 
  mutate(trt = replace(trt, trt == 2, "TEBU")) %>% 
  mutate(trt = replace(trt, trt == 3, "PROP")) %>% 
  mutate(trt = replace(trt, trt == 4, "PROT")) %>% 
  mutate(trt = replace(trt, trt == 5, "TEBU+PROT")) %>% 
  mutate(trt = replace(trt, trt == 6, "MET")) 
```

### Arm-based model

I will use the [metafor](http://www.metafor-project.org/doku.php) package, a free and open-source add-on for conducting meta-analyses with the statistical software environment R. I followed the example for fitting the arm-based network MA as shown in [this presentation](http://www.wvbauer.com/lib/exe/fetch.php/talks:2016_viechtbauer_goettingen_multilevel_multivariate_network_ma.pdf) by the author of the package.

In the original paper (Madden et al. 2016), the authors compared three different variance-covariance matrix for a random-effects model: compound simetry (CS), heterogeneous CS (HCS) and unstructured (UN). Thse can be informed directly in the `rma.mv` function.

Let's load `metafor` package.

```{r message=FALSE, warning=FALSE}
library(metafor)
```

## Fixed effects model

Here is how to fit Model F1, the fixed-effects model, with a CS (compound symmetry) structure. In metafor, we will use the `rma.mv` function for fitting mixed effects model for multivariate and multi-treatment situations. We enter the effect of interest, which is `yield` and the sampling variance `varyld`. Our moderators will be the additive effect of treatment `trt` and the trial `trial` in the fixed effects model. The `method` is the maximum likelihood. The `random` component will be treatment and trial, meaning a random intercept and slope for each treatment. The `struct` is CS and the `data` is wheat.

```{r, cache=TRUE}
net_arm_CS_fixed <- rma.mv(yield, varyld,
                    mods = ~ trial + trt, 
                    method= "ML",
                    random = list(~ trt | factor(trial)),  
                    struct="CS", 
                    data=wheat)


```

```{r}
summary(net_arm_CS_fixed)
```

## Random effects

For the random effects model, the specification is similar to the fixed, except that trials are considered only random effects in the model.

### Compound symmetry

Let's first fit the model with a compound symmetry (CS) structure for the variance-covariance matrix, which is equivalent to the R1 model in the paper @madden2016. In that case, because all treatments within a study share the same random effect, all treatments are correlated, with a covariance for pairs of treatments given by the between-study variance @madden2016

```{r, cache = TRUE}
net_arm_CS <- rma.mv(yield, varyld,
                    mods = ~ trt, 
                    method= "ML",
                    random = list(~ trt | factor(trial)),  
                    struct="CS",  
                    data=wheat)

```

Let's see the results.

```{r}
summary(net_arm_CS)
```

### Heterogeneous CS

Alternatively, between-study variance can be considered unequal when there is an overall random study effect. In this model there is a constant between-study correlation for all pairs of treatments with unequal between-study total variances, and this matrix is called heterogeneous compound symmetry (HCS). This the R2 model in @madden2016.

```{r, cache=TRUE}
# Be patient. The model fit may take more than a minute running
net_arm_HCS <- rma.mv(yield, varyld,
                    mods = ~  trt, 
                    method= "ML",
                    random = list(~ trt | factor(trial)),  
                    struct="HCS",  data=wheat)

```

And the results.

```{r}
summary(net_arm_HCS)
```

### Unstructured matrix

Finally, we fit the model with an unstructured (UN) variance-covariance matrix. Here, we allow the matrix to be completely unstructured, with different variance for each treatment or different covariance (correlation) for each pair of treatments. Note: I needed to use an optimizer for allowing convergence.

```{r, cache = TRUE}
# Be more patient. This may take much longer to complete run.
net_arm_UN <- rma.mv(yield, varyld,
                    mods = ~ trt, 
                    method= "ML",
                    random = list(~ trt | factor(trial)), 
                    struct="UN", 
                    control=list(optimizer = "nlm"), 
                    data=wheat)
```

Let's see the results:

```{r}
summary(net_arm_UN)
```

### Model comparison

Let's extract the mean estimate and the respective standard error from each of the models namely R1 (CS), R2(HCS) and R3(UN) as in the original paper.

```{r message=FALSE, warning=FALSE}
library(broom)

R1_mean <- tidy(round(net_arm_CS$b, 3))
R2_mean <- tidy(round(net_arm_HCS$b,3))
R3_mean <- tidy(round(net_arm_UN$b,3))
R1_se <- tidy(round(net_arm_CS$se,3))
R2_se <- tidy(round(net_arm_HCS$se,3))
R3_se <- tidy(round(net_arm_UN$se,3))


```

And now we prepare a table for displaying the statistics.

```{r}
table1 <- 
  data.frame(R1_mean, R1_se, R2_mean, R2_se, R3_mean, R3_se)
colnames(table1) <- c("R1_mean", "R1_se", "R2_mean", "R2_se", "R3_mean", "R3_se")
table1$Treat <- c("CTRL", "MET", "PROP", "PROT", "TEBU", "TEBU+PROT")
table1

```

As in the original paper, we will compare all three models based on the LRT test. The full model uses the UN variance-covariance matrix. As in the paper, the UN provided a better fit to the data and had the lowest AIC.

```{r}
anova(net_arm_HCS, net_arm_CS)
anova(net_arm_CS, net_arm_UN)
anova(net_arm_HCS, net_arm_UN)

```

Using the best model, we can apply a multi-comparison test for a head-to-head comparison based on the network model results. We can do it using `multcomp` package.

```{r message=FALSE, warning=FALSE}
library(multcomp)
net_arm_UN_comp <- summary(glht(net_arm_UN, linfct=cbind(contrMat(rep(1,6), type="Tukey")), test=adjusted("none")))
net_arm_UN_comp

```

And we can make a plot for it.

```{r}
plot(net_arm_UN_comp)
```

### Moderator effects

In the original paper, two models were expanded to include the effect of wheat class(S = Spring wheat and W = Winter wheat) as moderator. Let's fit the CS model as in the paper with the moderator.

```{r, cache=TRUE}

net_arm_CS_class <- rma.mv(yield, varyld,
                    mods = ~ factor(trt)*class, 
                    method= "ML",
                    random = list(~ factor(trt) | factor(trial)),  
                    struct="HCS",  data=wheat)

```

As usual, we look at the model summary. Now we can see estimates for each combination of treatment and wheat class.

```{r}
summary(net_arm_CS_class)
```

We can check whether the full model with the moderator is a better fit than the reduced (without moderator) model. The P-value of the LRT test suggests that indeed wheat class has a strong effect on treatment effects. This agrees with the results using SAS.

```{r}
anova(net_arm_CS, net_arm_CS_class)
```

### Wrapping up

So recapping, we fitted five models: fixed effects, three random effects with different structures and the one with a moderator variables. Results are not identical to those obtained in @madden2016, but they are all very similar.

These methods above, mainly the unstructured (UN) model, has been fitted in meta-analysis studies conducted in my laboratory. All the codes are made available and anyone should be able to reproduce it after downloading the research compendium and installing all the required packages (RStudio will tell you when you open the Rmd file!).

### To know more

You may want to check these repositories of code and data from work published in my lab using these methods.

@barro2021, @barro2020, [Machado et al. (2017)](https://emdelponte.github.io/paper-FHB-Brazil-meta-analysis/)

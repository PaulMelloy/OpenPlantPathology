---
title: "Estimating leaf temperatures for spatial eppidemiolgy"
description: |
  How to obtain leaf temperature estimates world-wide using R packages `tealeaves` and `nasapower`.
author:
  - name: Paul Melloy
date: 2022-04-01
output:
  distill::distill_article:
    self_contained: false
categories: 
  - R4PlantPath
  - Reproducible Research
bibliography: bibliography.bib
---

## Introduction  

The incidence and severity of plant diseases are dependant on environmental effects
which is emphasised by the [disease triangle](https://www.apsnet.org/edcenter/foreducators/TeachingNotes/Pages/DiseaseTriangle.aspx).
Arguably the effect of temperature on disease can be the most important of environmental influences.
One problem with evaluating the effect of temperatures on disease incidence and 
severity is the difference between air temperatures measured at weather station 
and the micro-environment of the plant canopy.  

When modelling plant disease outbreaks, being able to more accurately estimate the 
conditions which lead to localised plant disease epidemics can be very useful. 
This led me to the R package [_tealeaves_](https://CRAN.R-project.org/package=tealeaves)[@Muir2019], 
which provides functions for calculating leaf temperatures from ambient environmental inputs.  
  
If you have not already, install the packages _tealeaves_ and _nasapower_ with `install.packages(c("tealeaves", "nasapower"))`.  

## `tealeaves`

```{r load_library}
library(tealeaves)
```

Before we begin, it is worth noting _tealeaves_ uses the package [_units_](https://cran.r-project.org/web/packages/units/vignettes/units.html) to format the inputs and outputs.
More detail about the package _tealeaves_ and it's functions can be found in Muir's
publication [@Muir2020], and in the vignettes which can be obtained by running the 
following commands in R `vignette("tealeaves-introduction")` or `vignette("tealeaves-intermediate")`. 
Therefore I will not go in too much depth here, but show the briefest example.  

```{r simple_example}
lf_par <- make_leafpar()
env_par <- make_enviropar()
const <- make_constants()

Tm_leaf <- 
  tleaf(leaf_par = lf_par,
      enviro_par = env_par,
      constants = const)

Tm_leaf[, c("T_leaf","E")]
```


The function `tleaf()` calculates leaf temperature and other leaf functions by solving
an energy budget equation. This equation requires a number of parameter inputs which 
are created or altered through the package functions:  

  - `make_leafpar()` defines the leaf parameters and characteristics.  
  - `make_enviropar()` sets environmental parameters.  
  - `make_constants()` defines the constants used in the `tleaf()` equation.  
<br>  

The `tleaf()` returns an output containing details of the thermal energy absorbed
and emitted, including an estimate of evapotranspiration (`"E"`), which assists in 
defining the estimated leaf temperature (`"T_leaf"`).  

We can replace the default environmental parameters with values parsed from a 
weather station or remote sensing satellite data retrieved by using the R package
_nasapower_.  

## `nasapower`

Lets download some hourly data using the _nasapower_ package. 
More information on using the _nasapower_ package can be found by calling the vignette
as follows `vignette(nasapower)`.  

```{r get_power}
library(nasapower)
np <- get_power(
  community = "ag",
  pars = c(
    "RH2M", # Relative humidity at 2 meters
    "T2M", # Air temperature at 2 meters
    "WS2M", # wind speed at 2 meters
    "ALLSKY_SFC_SW_DWN", # short wave downward solar radiation at the earth surface
    "ALLSKY_SFC_LW_DWN", # long wave downward solar radiation at the earth surface
    "PS", # surface pressure
    "ALLSKY_SRF_ALB" # Surface albedo
  ),
  temporal_api = "hourly",
  lonlat = c(150.884226, -26.826118),
  dates = c("2021-06-01", "2021-06-08")
)

```

In the `get_power()` function above, we have requested "NASA POWER" data from the
agricultural weather data collection (`"ag"`). These data contain all the energy
balance input data needed from a 1 degree grid cell at the given `latlong` coordinates.
In addition we have requested hourly data for the first week in June 2021 with the 
`"temporal_api"` argument.  

```{r print_data}
np
```

<br>  

## Estimate leaf temperatures  

Next we will characterise the environmental parameters using the `np` data at 
a single time point into the `tleaf()`.  

```{r make_new_par}
env_par <- make_enviropar(
  replace = list(
    P = set_units(np$PS[1], "kPa"),
    r = set_units(np$ALLSKY_SRF_ALB[1]),
    RH = set_units(np$RH2M[1]/100), # needs to be specified as a proportion
    S_sw = set_units(np$ALLSKY_SFC_SW_DWN[1], "W/m^2"),
    T_air = set_units(
      set_units(np$T2M[1], "DegC"),
      "K"),# convert from degrees to Kelvin
    wind = set_units(np$WS2M[1], "m/s")
    )
)
```

<br>  

Now we can run the `tleaf()` function again with the updated environmental parameters.  

```{r leaf_data}
Tm_leaf <- 
  tleaf(leaf_par = lf_par,
      enviro_par = env_par,
      constants = const)

Tm_leaf[, c("T_leaf","E")]
```

<br>  

Because the outputs are specified using the _units_ package we can easily convert
from Kelvin back to degrees Celsius using the `set_units()` function again.  

```{r leaf_temp}
set_units(Tm_leaf$T_leaf, "DegC")
```

<br>  

## Leaf temperature gradients

The _tealeaves_ vignette describes how the input of multiple values will return permutations
of the environmental parameters to describe leaf temperature over a gradient.  

```{r leaf_grad}
env_par <- make_enviropar(
  replace = list(
    P = set_units(np$PS[1:2], "kPa"),
    r = set_units(np$ALLSKY_SRF_ALB[1:2]),
    RH = set_units(np$RH2M[1:2]/100), # needs to be specified as a proportion
    S_sw = set_units(np$ALLSKY_SFC_SW_DWN[1:2], "W/m^2"),
    T_air = set_units(
      set_units(np$T2M[1:2], "DegC"),
      "K"),# convert from degrees to Kelvin
    wind = set_units(np$WS2M[1:2], "m/s")
    )
)

Tm_leaves <- 
  tleaves(leaf_par = lf_par,
      enviro_par = env_par,
      constants = const)

dim(Tm_leaves)
head(Tm_leaves[, c("T_leaf","E")])
```
We can see that the `tleaves()` function expects multiple values specified in the 
environmental parameters would indicate a gradient of different values. 
As such all 64 (`2^6`) permutations of these values are returned.  

## Leaf temperature time-series

To obtain a time series we can use the `apply` function to parse the environmental
parameters to `tleaf` one time point at a time.  

First we need to clean up the data a little by substituting `NA` albedo values generated 
by night-time measurements. Here I have substituted it with the mean.  

```{r sub_na}
np$ALLSKY_SRF_ALB[
  is.na(np$ALLSKY_SRF_ALB)] <- mean(np$ALLSKY_SRF_ALB, na.rm = TRUE)
```


```{r apply_tleaf}
tm_leaf_list <-
  apply(np, 1, function(nasa_p){
    
    env_par <- make_enviropar(
      replace = list(
        P = set_units(nasa_p["PS"], "kPa"),
        r = set_units(nasa_p["ALLSKY_SRF_ALB"]),
        RH = set_units(nasa_p["RH2M"] / 100), # needs to be specified as a proportion
        S_sw = set_units(nasa_p["ALLSKY_SFC_SW_DWN"], "W/m^2"),
        T_air = set_units(set_units(nasa_p["T2M"], "DegC"),
                          "K"), # convert from degrees to Kelvin
        wind = set_units(nasa_p["WS2M"], "m/s")
      )
    )
    
    return(
      tleaf(leaf_par = lf_par,
            enviro_par = env_par,
            constants = const,
            quiet = TRUE))
    
  })

# bind the list into a data.frame
Leaf_temperatures <-
  do.call("rbind",c(tm_leaf_list, make.row.names = FALSE))

Leaf_temperatures[1:10,c("T_leaf","E")]
```

<br>  

We can now pair up the time and air temperature data from the NASA power data with 
the leaf temperature data. Also we will convert temperature in Kelvin to degrees
Celsius.  

```{r tidy_tleaf}
Leaf_temperatures$air_temp <-
  np$T2M

Leaf_temperatures$times <-
  as.POSIXct(paste0(np$YEAR,"-",
                    np$MO, "-",
                    np$DY, " ",
                    np$HR, ":00:00"), 
             tz = "Australia/Brisbane")
Leaf_temperatures$T_leaf <-
  set_units(Leaf_temperatures$T_leaf, "DegC")

```

<br>  

## Ploting leaf temperature

Finally we can visualise the change in air temperature and leaf temperatures over
time.  

```{r plot_tleaf}
library(ggplot2)


ggplot(Leaf_temperatures,
       aes(x = times))+
  geom_line(aes(y = air_temp, colour = "darkblue"), size = 1)+
  geom_line(aes(y = drop_units(T_leaf),
            colour = "forestgreen"), size = 1)+
  labs(y = "Temperature (Degrees Celcius)",
       color = "Estimates")+
  theme_minimal()+
  scale_color_manual(values = c("darkblue","forestgreen"),
                     labels = c("Air Tm",
                                "Leaf Tm"))

```

## Conclusion

Hopefully this will help get you started for using these two packages to estimate leaf
and canopy temperatures. However further parameterisation would be necessary prior
to any in-depth analyses. Leaf parameters, such as leaf size, reflectance, absorbance, 
stomatal conductance and ratio should be carefully considered in addition to vertical 
environmental gradients across the height of the plant. Shading in the canopy is 
known to effect pathogen infection, colonisation and sporulation in addition to 
leaf wetness.


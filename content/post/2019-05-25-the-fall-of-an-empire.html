---
title: The Fall of an Empire
author: Emerson M. Del Ponte
date: '2019-05-25'
slug: the-fall-of-an-empire
categories: ["R", "Tutorial", "Programming", "Visualization"]
tags: [""]
header:
  caption: ''
  image: ''
output: html_document
---



<p>I recently tweeted an animated GIF that depicted the yearly variation in efficacy of tebuconazole, a DMI fungicide, evaluated in field trials, for the control of soybean rust in a major soybean region of Brazil (Mato Grosso state).</p>
<blockquote class="twitter-tweet" align="center" data-lang="pt">
<p lang="en" dir="ltr">
This is what happens when one fungicide (DMI in this case) is massively used over many years in a large soybean-growing region. Life finds a way. Showed this in my talk this AM “To spray or not to spray”. <a href="https://t.co/uFf6VbSieb">pic.twitter.com/uFf6VbSieb</a>
</p>
— Emerson Del Ponte (<span class="citation">@edelponte</span>) <a href="https://twitter.com/edelponte/status/1131633376182579207?ref_src=twsrc%5Etfw">23 de maio de 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br><br>
The Asian rust is the most damaging disease of soybean in Brazil since it was discovered in 2004, for which no other method than fungicides are available so far for an effective control. The tweet got a lot of attention, not only because of the important issue, but I think also because of the nice way to visualize the data. So I decided to share the R code use to produce the animation for other’s presentations.</p>
<p>The data used here are from a more complete set obtained from a meta-regression study where the effect of year was tested as moderator variable (<a href="https://apsjournals.apsnet.org/doi/abs/10.1094/PDIS-03-17-0408-RE">Dalla Lana et al. 2018</a>). The data of that study have been made available (<a href="https://osf.io/7d3ch/">Del Ponte et al. 2017</a>), which makes it possible to reuse them!</p>
<p>We will start by importing, inspecting and preparing the data for visualization. I like the tidyverse tools and programming style, so this package is essentially the first to load. The data are available in one of my <a href="https://osf.io/7d3ch/">OSF project</a> as an <code>csv</code> file. In the files panel, look for the <code>sev_data.csv</code> file within the data subfolder. Let’s import the web-hosted file into R using <code>read_csv</code> function. You need internet connection, but you may want to save the dataframe locally.</p>
<pre class="r"><code>library(tidyverse)
fungicide &lt;- read_csv(&quot;https://osf.io/rp7nb/download&quot;)</code></pre>
<div id="data-inspection" class="section level2">
<h2>Data inspection</h2>
<p>Let’s see how many treatments and the number of entries per treatment. These are the different levels of the <code>active_ingredient</code> column, including the nontreated check. I like to use the <code>tabyl</code> function of the <em>janitor</em> package as substitute for <code>table()</code>, so you can do the same using the latter base function if you prefer.</p>
<pre class="r"><code>library(janitor)
fungicide %&gt;%
  tabyl(active_ingredient) %&gt;%
  arrange(-n)</code></pre>
<pre><code>##   active_ingredient   n    percent
## 1             check 250 0.17385257
## 2              tebu 248 0.17246175
## 3         azox_cypr 212 0.14742698
## 4         pyra_epox 154 0.10709318
## 5              cypr 146 0.10152990
## 6         pico_cypr 144 0.10013908
## 7         trif_prot 109 0.07579972
## 8         pyra_metc  96 0.06675939
## 9              azox  79 0.05493741</code></pre>
<p>And now we can make a pivot table for active ingredient versus year to check those used for longer time and lower gaps. The values represent the number of trials where the fungicide was evaluated within a specific year.</p>
<pre class="r"><code>fungicide %&gt;%
  tabyl(active_ingredient, year) %&gt;%
  arrange(active_ingredient)</code></pre>
<pre><code>##   active_ingredient 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014
## 1              azox    0    0   19    0    0    0    0   17   23   20
## 2         azox_cypr   19    0   20   11   53   28   21   17   23   20
## 3             check   19   19   39   11   53   28   21   17   23   20
## 4              cypr    0   18   19    0    0   28   21   17   23   20
## 5         pico_cypr    0    0    0   11   25   28   21   17   22   20
## 6         pyra_epox    0    0   20    0   25   28   21   17   23   20
## 7         pyra_metc    0    0    0    0   28   27   21    0    0   20
## 8              tebu   19   19   37   11   53   28   21   17   23   20
## 9         trif_prot    0    0    0    0   28    0   21   17   23   20</code></pre>
<p>Besides the nontreaed check with the largest sample size (250 independent experiments), the fungicides evaluated in most years were <strong>tebu</strong> and <strong>azox+cypro</strong>, or eight years (2007 to 2014). We will need the check treatment as well. I like to subset the data using the <code>filter()</code> function so we keep only te relevant data to work further.</p>
</div>
<div id="data-preparation" class="section level2">
<h2>Data preparation</h2>
<pre class="r"><code>tebu_mix &lt;- fungicide %&gt;%
  filter(active_ingredient %in% c(&quot;check&quot;, &quot;tebu&quot;, &quot;azox_cypr&quot;)) %&gt;%
  arrange(trial) # ordered by trial</code></pre>
<p>The trials were conducted at several states in Brazil. Let’s see how many trials per state and year.</p>
<pre class="r"><code>fungicide %&gt;%
  tabyl(state, year)</code></pre>
<pre><code>##  state 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014
##     BA    3    3    6    8    0    7    0    0    0    0
##     DF    3    0    8    0   10    0    8   16    8    9
##     GO    9   12   24    4   40   42   24   32   40   54
##     MA    3    0    8    0    0    0    0    0    0    0
##     MG    3    3    8    4   10    7    0    0    0    0
##     MS    6    9   36    8   45   20   16    8   24    9
##     MT    3    3    8    0   80   21   32   24   32   45
##     PR   12   14   32   16   30   42   32   24   48   36
##     RS    0    3    0    4   25   35   32    8   16    9
##     SC    0    0    0    0    0    7   16    8    0    0
##     SP   15    9   16    0   25   14    8   16   15   18
##     TO    0    0    8    0    0    0    0    0    0    0</code></pre>
<p>I want to eliminate from our analysis states with too many gaps in the years and group states by climatic region or geographical proximity. I split all six remaining states into three groups as follows.</p>
<pre class="r"><code>tebu_mix1 &lt;- tebu_mix %&gt;%
  filter(!state %in% c(&quot;SC&quot;, &quot;TO&quot;, &quot;MA&quot;, &quot;MG&quot;, &quot;BA&quot;, &quot;DF&quot;)) %&gt;%
  mutate(region = case_when(
    state %in% c(&quot;MT&quot;, &quot;GO&quot;) ~ &quot;MT+GO&quot;,
    state %in% c(&quot;SP&quot;, &quot;MS&quot;) ~ &quot;SP+MS&quot;,
    state %in% c(&quot;PR&quot;, &quot;RS&quot;) ~ &quot;PR+RS&quot;
  ))</code></pre>
<p>Now we need to create our variable of interest, or the percent reduction in disease severity relative to the non-treated check, commonly reffered to control efficacy. This can be done by first reshaping data to the wide format using the <code>spread()</code> function. Then, with the three response variables in separate columns, we can create the new variable of interest using the <code>mutate()</code> function. The efficacy is obtained from the ratio of fungicide-treated and nontreated subtracted from 1. Hence, the larger the efficacy (zero to 100%), the better is the fungicide. Note that <code>selection()</code> was used to preserve only the columns that are relevant. Note: negative values can be calculated in rare situations where disease severity in the fungicide-treated plot is higher than in the non-treated check of the same experiment.</p>
<pre class="r"><code>tebu_mix2 &lt;- tebu_mix1 %&gt;%
  select(trial, year, state, region, active_ingredient, severity) %&gt;%
  spread(active_ingredient, severity) %&gt;%
  mutate(
    tebu_eff = 100 - (tebu / check * 100),
    azox_cypr_eff = 100 - (azox_cypr / check * 100)
  ) %&gt;%
  select(1:4, 8:9)
head(tebu_mix2)</code></pre>
<pre><code>## # A tibble: 6 x 6
##   trial  year state region tebu_eff azox_cypr_eff
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;     &lt;dbl&gt;         &lt;dbl&gt;
## 1     2  2005 PR    PR+RS      96.5          98.1
## 2     4  2005 MS    SP+MS      94            90  
## 3     5  2005 MT    MT+GO      97.1          95.9
## 4     6  2005 GO    MT+GO      62.3          43.0
## 5     7  2005 GO    MT+GO      99.0          99.0
## 6     8  2005 PR    PR+RS      98.7          98.7</code></pre>
</div>
<div id="data-visualization" class="section level2">
<h2>Data visualization</h2>
<p>Now that our dataset is ready, let’s make a static plot just for quick visualization. First we want to reshape the data back to the long format using <code>gather()</code> for producing side by side plots by another variable using <code>facet_wrap</code>.</p>
<pre class="r"><code># reorder levels of the region factor
tebu_mix2$region2 &lt;- factor(tebu_mix2$region, levels = c(&quot;MT+GO&quot;, &quot;SP+MS&quot;, &quot;PR+RS&quot;))

tebu_mix2 %&gt;%
  select(year, region2, state, tebu_eff, azox_cypr_eff) %&gt;%
  gather(key = treatment, value = efficacy, -c(1:3)) %&gt;%
  ggplot(aes(year, efficacy, color = region2)) +
  geom_jitter(width = 0.2, alpha = 0.7) +
  facet_grid(region2 ~ treatment) +
  theme_grey() +
  theme(legend.position = &quot;top&quot;) +
  labs(x = &quot;Harvest year&quot;, y = &quot;Percent disease reduction&quot;, color = &quot;Region&quot;)</code></pre>
<pre><code>## Warning: Removed 32 rows containing missing values (geom_point).</code></pre>
<p><img src="/post/2019-05-25-the-fall-of-an-empire_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="gganimate-plots" class="section level2">
<h2>gganimate plots</h2>
<p>Now the fun plots! we will use the <em>gganimate</em> package to produce a GIF animation. There is no trouble here as we just need to add <code>year</code> variable in the <code>transition_time</code> function. Further details in official <a href="https://gganimate.com/articles/gganimate.html">package documentation</a>. I learnt that in my example year should be transformed to an integer to prevent it from display several decimals.</p>
<p>Three other functions I found interesting to add to the animation (see after <code>transition_time</code>). More tricks on using gganimate <a href="https://www.listendata.com/2019/05/create-animation-in-r-learn-with.html?m=1">here</a></p>
<pre class="r"><code>library(gganimate)

tebu_decline &lt;- tebu_mix2 %&gt;%
  select(year, region2, tebu_eff, azox_cypr_eff) %&gt;%
  gather(key = treatment, value = efficacy, -c(1:2)) %&gt;%
  filter(efficacy &gt; 0)

tebu_anima &lt;- tebu_decline %&gt;%
  ggplot(aes(year, efficacy, color = region2)) +
  geom_jitter(
    size = 3,
    alpha = 0.5
  ) + 
  scale_x_continuous(breaks = c(2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015)) +
  transition_time(as.integer(year)) +
  ease_aes(&quot;linear&quot;) +
  exit_fade() +
  shadow_trail(max_frames = 7) +
  labs(
    title = &quot;Efficacy ot fungicides for soybean rust control&quot;,
    subtitle = &quot;Each dot is one experiment. Year: {frame_time}&quot;,
    x = &quot;Harvest year&quot;,
    y = &quot;Disease reduction relative to nontreated (%)&quot;,
    caption = &quot;Source: Dalla Lana (2018)&quot;,
    color = &quot;States&quot;
  ) +
  theme_minimal()+
  theme(legend.position = &quot;right&quot;) +
  facet_grid(region2 ~ treatment)
animate(tebu_anima, width = 600, height = 500) </code></pre>
<p><img src="/post/2019-05-25-the-fall-of-an-empire_files/figure-html/unnamed-chunk-9-1.gif" /><!-- --></p>
<p>This is it! Don’t forget to save this current animation to GIF using:</p>
<pre class="r"><code>anim_save(&quot;tebuconazole-decline.gif&quot;, last_animation())</code></pre>
</div>
